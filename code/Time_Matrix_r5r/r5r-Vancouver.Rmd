---
title: "R5-vancouver_transit"
author: "Yuxuan"
date: "10/05/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# install the ('R5R') package from CRAN
```{R}
# CRAN
#install.packages('r5r')
#install.packages('mapview')
# github
devtools::install_github("ipeaGIT/r5r", subdir = "r-package")
```
#  loading library
```{R}
library(r5r)
library(sf)
library(rJava)
library(data.table)
library(ggplot2)
library(mapview)
library(tidyr)
library(readr)
library(dplyr)
library(uuid)
mapviewOptions(platform = 'leafgl')
```


# loading proccessed data

```{r}
POI <- read.csv("vancouver_facilities.csv",header = T)
DBs <- read.csv("vancouver_db.csv",header = T)
```
# function description 
The r5r package has 3 fundamental functions.

1. setup_r5() to initialize an instance of r5r, that also builds a routable transport network given an Open Street Map street network and public transport feeds in GTFS format;

2. travel_time_matrix() for fast computation of travel time estimates between origin/destination pairs;

3. detailed_itineraries() to get detailed information on one or multiple alternative routes between origin/destination pairs.

```{R}
options(java.parameters = "-Xmx8G")
```

```{R}

path = getwd()
r5r_core <- setup_r5(data_path = path, verbose = FALSE)
```

```{R}
origins <- fread(file.path(getwd(), "vancouver_db.csv"))

```


```{R}

#formatting origins
origin<-DBs
origin$id<-DBs$DBUID
origin%>%dplyr::select(id,lat,lon)->origin
na.omit(origin)->origin
origin$id<-as.character(origin$id)

```


```{R}
# formatting destinations
destination<-POI
destination$lat<-as.numeric(POI$Latitude)
destination$lon<-as.numeric(POI$Longitude)
destination$id<-as.character(POI$Index)
destination%>%select(id,lat,lon)->destination
na.omit(destination)->destination
```


```{R}
POI
```


```{r}

# set inputs
mode <- c("WALK", "TRANSIT")
departure_datetime<-as.POSIXct("03-02-2021 11:00:00",format = "%d-%m-%Y %H:%M:%S")
max_walk_dist<-2000 # meter
max_trip_duration<- 120 #minutes
max_rides<-3 # max transfer times

ttm <- travel_time_matrix(r5r_core = r5r_core,
                          origins = origin,
                          destinations = destination,
                          mode = mode,
                          max_rides=max_rides, # max transfer
                          time_window = 2, 
                          max_walk_dist = max_walk_dist, # meter
                          max_trip_duration =  max_trip_duration, # minutes
                          verbose = FALSE)


```


```{R}
length(unique(ttm$fromId))
length(unique(ttm$toId))
```


```{R}
summary(ttm)
```


```{r}
ttm%>%group_by(ttm$fromId)%>%count()

ttm%>%group_by(ttm$toId)%>%count()
```





```{R}
# detailed info on multiple alternative routes
det <- detailed_itineraries(r5r_core = r5r_core,
                            origins = origin[1,],
                            destinations = destination[67,],
                            mode = mode,
                            #departure_datetime = departure_datetime,
                            #max_walk_dist = max_walk_dist,
                            max_trip_duration = 300,
                            shortest_path = FALSE,
                            verbose = FALSE)


```


```{R}
head(det)

```


```{R}

# extract OSM network
street_net <- street_network_to_sf(r5r_core)

# plot
ggplot() +
  geom_sf(data = street_net$edges, color='gray85') +
  geom_sf(data = det, aes(color=mode)) +
  facet_wrap(.~option) + 
  theme_void()
```


```{R}

stop_r5(r5r_core)
rJava::.jgc(R.gc = TRUE)
```

